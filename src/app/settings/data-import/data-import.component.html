<div class="page-content">
  <h2>{{ 'data_import.csv' | translate }}</h2>
  <p>{{ 'data_import.import_explanation_csv' | translate }}</p>
  <mat-stepper orientation="vertical" [linear]="true" #stepper [disableRipple]="true">
    <mat-step completed="false">
      <ng-template matStepLabel>
        <h3>{{ 'data_import.choose_csv_file' | translate }}</h3>
      </ng-template>
      <div class="form-row">
        <button color="dark" mat-raised-button class="upload-button" data-qa="btn-upload">
          {{ selectedFile ? 'Change' : 'Upload' }} file
          <input name="file" type="file" accept=".csv" (change)="uploadFile($event)" />
        </button>
        <span class="seleted-file" *ngIf="selectedFile">{{ selectedFile.name }}</span>
      </div>

      <div class="form-row">
        <mat-form-field class="survey-select" appearance="outline">
          <span class="survey-select__prefix" matPrefix>
            {{ 'data_import.import_to' | translate }}&nbsp;
          </span>
          <mat-select
            data-qa="select-survey"
            disableOptionCentering
            [(value)]="selectedForm"
            [placeholder]="'data_import.which_survey' | translate"
          >
            <mat-option *ngFor="let option of forms$ | async" [value]="option">
              {{ option.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <button mat-raised-button color="primary" (click)="completeStepOne()" data-qa="btn-continue">
        {{ 'settings.continue' | translate }}
      </button>
    </mat-step>
    <mat-step completed="false">
      <ng-template matStepLabel>
        <h3>{{ 'data_import.configure_imported_posts' | translate }}</h3>
      </ng-template>
      <ng-template matStepContent>
        <div class="form-row">
          <ul class="metadata">
            <li>{{ selectedFile.name }}</li>
            <li>{{ selectedForm.name }}</li>
          </ul>
        </div>

        <div class="radio-group">
          <h3>{{ 'data_import.imported_posts_status' | translate }}</h3>
          <mat-radio-group
            data-qa="radio-option"
            [(ngModel)]="statusOption"
            [attr.aria-label]="'data_import.imported_posts_status' | translate"
          >
            <div class="radio-group">
              <mat-radio-button value="mark_as">
                {{ 'data_import.marked_as' | translate }}
              </mat-radio-button>
              <div *ngIf="statusOption === 'mark_as'" class="radio-group__content">
                <mat-radio-group [(ngModel)]="selectedStatus" data-qa="radio-status">
                  <div class="radio-group">
                    <mat-radio-button [value]="PostStatus.Published">
                      <mat-icon matPrefix>
                        <svg class="iconic" role="img">
                          <use xlink:href="assets/sprites.svg#globe"></use>
                        </svg>
                      </mat-icon>
                      {{ 'post.published' | translate }}
                    </mat-radio-button>

                    <!--// IF the chosen survey has tasks that must be completed before its posts can be published //-->
                    <p *ngIf="hasRequiredTask">
                      Your survey, <strong>{{ selectedForm.name }}</strong>
                      , includes tasks that typically must be completed for each post before they
                      can be marked 'published.' During this import, all of your imported posts will
                      have their tasks marked as 'incomplete', while still allowing their status to
                      be marked as 'published.' If you edit any of these posts after they've been
                      imported, however, you'll be asked to complete those tasks before
                      re-publishing them.
                    </p>
                    <!--// END IF //-->
                  </div>

                  <div class="radio-group">
                    <mat-radio-button [value]="PostStatus.Draft">
                      <mat-icon matPrefix>
                        <svg class="iconic" role="img">
                          <use xlink:href="assets/sprites.svg#document"></use>
                        </svg>
                      </mat-icon>
                      {{ 'post.draft' | translate }}
                    </mat-radio-button>
                  </div>

                  <div class="radio-group">
                    <mat-radio-button [value]="PostStatus.Archived">
                      <mat-icon matPrefix>
                        <svg class="iconic" role="img">
                          <use xlink:href="assets/sprites.svg#box"></use>
                        </svg>
                      </mat-icon>
                      {{ 'post.archived' | translate }}
                    </mat-radio-button>
                  </div>
                </mat-radio-group>
              </div>
            </div>

            <div class="radio-group">
              <mat-radio-button value="defined_column">
                {{ 'data_import.defined_column' | translate }}
              </mat-radio-button>
              <div class="radio-group select" *ngIf="statusOption === 'defined_column'">
                <div class="radio-group__content">
                  <mat-form-field appearance="outline">
                    <mat-select [(ngModel)]="selectedStatus" disableOptionCentering>
                      <mat-option
                        *ngFor="let column of uploadedCSV.columns; let i = index"
                        [value]="i"
                      >
                        {{ column }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>
                  <p>
                    <em>{{ 'data_import.status_explanation' | translate }}</em>
                  </p>

                  <!--// IF the chosen survey has tasks that must be completed before its posts can be published //-->
                  <p class="note">
                    Your survey, <strong>{{ selectedForm.name }}</strong
                    >, includes tasks that typically must be completed for each post before they can
                    be marked 'published.' During this import, all of your imported posts will have
                    their tasks marked as 'incomplete', even if their status is marked as
                    'published.' If you edit any of these posts after they've been imported,
                    however, you'll be asked to complete those tasks before re-publishing them.
                  </p>
                  <!--// END IF //-->
                </div>
              </div>
            </div>
          </mat-radio-group>
        </div>

        <h3>{{ 'data_import.choose_which_column' | translate }}</h3>
        <p>{{ 'data_import.each_survey_field' | translate }}</p>

        <table mat-table *ngIf="selectedForm.attributes" [dataSource]="selectedForm.attributes">
          <ng-container matColumnDef="survey">
            <th mat-header-cell *matHeaderCellDef>{{ 'data_import.survey_field' | translate }}</th>
            <td mat-cell *matCellDef="let attribute">
              {{ attribute.label }}&nbsp;<span class="color-accent" *ngIf="attribute.required"
                >*</span
              >
            </td>
          </ng-container>

          <ng-container matColumnDef="csv">
            <th mat-header-cell *matHeaderCellDef>{{ 'data_import.csv_column' | translate }}</th>
            <td mat-cell *matCellDef="let attribute">
              <mat-form-field appearance="outline">
                <mat-select
                  data-qa="select-columns"
                  disableOptionCentering
                  [(ngModel)]="maps_to[attribute.key]"
                  [placeholder]="'data_import.leave_empty' | translate"
                >
                  <mat-option selected="selected" value="">
                    {{ 'data_import.leave_empty' | translate }}
                  </mat-option>
                  <mat-option *ngFor="let column of uploadedCSV.columns; let i = index" [value]="i">
                    {{ column }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
        </table>

        <div class="form-controls-panel">
          <button
            type="button"
            mat-raised-button
            (click)="cancelImport()"
            data-qa="btn-cancel-import"
          >
            {{ 'data_import.cancel_import' | translate }}
          </button>
          <button
            type="button"
            color="primary"
            mat-raised-button
            (click)="completeStepTwo()"
            data-qa="btn-finish"
          >
            {{ 'data_import.finish_import' | translate }}
          </button>
        </div>
      </ng-template>
    </mat-step>
  </mat-stepper>
</div>
