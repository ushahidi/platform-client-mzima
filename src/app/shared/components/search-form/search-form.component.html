<form
  novalidate
  [formGroup]="form"
  class="search-form"
  (submit)="applyFilters()"
  [ngClass]="{ 'search-form--map-view': isMapView }"
>
  <mat-form-field appearance="outline" class="search-form__control">
    <mat-icon matPrefix svgIcon="search"></mat-icon>
    <input
      matInput
      [(ngModel)]="searchQuery"
      [matAutocomplete]="cities"
      (ngModelChange)="searchOnMap()"
      class="search-form__form-control"
      [ngModelOptions]="{ standalone: true }"
      [placeholder]="'global_filter.search' | translate"
    />
    <mat-autocomplete
      autoActiveFirstOption
      autoSelectActiveOption
      #cities="matAutocomplete"
      [displayWith]="displayFn"
      class="search-autocomplete"
      (optionSelected)="optionSelected($event)"
    >
      <mat-option
        [value]="option"
        *ngFor="let option of citiesOptions | async"
        [disabled]="option.disabled"
      >
        {{ option.display_name }}
      </mat-option>
    </mat-autocomplete>
  </mat-form-field>
  <button type="button" mat-raised-button (click)="toggleFilters()" class="search-form__filters">
    <mat-icon class="search-form__filters__icon" svgIcon="filters"></mat-icon>
    {{ 'app.filters' | translate }}
  </button>

  <div class="search-form__main-filters" *ngIf="isMapView">
    <span class="search-form__main-filters__total">Results: {{ total }}</span>

    <div class="filter-group">
      <div class="filter-group__head">
        <label class="filter-group__title" for="surveys">{{ 'app.surveys' | translate }}</label>
        <button
          mat-button
          type="button"
          color="primary"
          (click)="clearFilter('form')"
          class="filter-group__head__button"
        >
          {{ 'nav.clear' | translate }}
        </button>
      </div>
      <mat-selection-list name="surveys" class="selection-list" formControlName="form">
        <mat-list-option
          color="primary"
          [value]="survey.id"
          checkboxPosition="before"
          class="selection-list__option"
          *ngFor="let survey of surveyList"
          [ngStyle]="{ '--color': survey.color }"
        >
          <span class="selection-list__option__border"></span>
          {{ survey.name }}
          <span class="selection-list__option__total">{{ survey.total || 0 }}</span>
        </mat-list-option>
      </mat-selection-list>

      <div class="filter-group__info" *ngIf="notShownPostsCount > 0">
        There are <a [routerLink]="['feed']">{{ notShownPostsCount }} posts</a> not shown here
        because they don't include location information.
      </div>
    </div>

    <div class="filter-group">
      <div class="filter-group__head">
        <label class="filter-group__title" for="source">{{
          'global_filter.source' | translate
        }}</label>
        <button
          mat-button
          type="button"
          color="primary"
          (click)="clearFilter('source')"
          class="filter-group__head__button"
        >
          {{ 'nav.clear' | translate }}
        </button>
      </div>
      <mat-selection-list name="source" class="selection-list" formControlName="source">
        <ng-container *ngFor="let source of sources">
          <mat-list-option
            color="primary"
            [value]="source.value"
            *ngIf="source.total > 0"
            checkboxPosition="before"
            class="selection-list__option"
          >
            {{ source.name }}
            <span class="selection-list__option__total">{{ source.total }}</span>
          </mat-list-option>
        </ng-container>
      </mat-selection-list>
    </div>
  </div>

  <div
    class="search-form__filters-panel"
    [ngClass]="{ 'search-form__filters-panel--open': isFiltersVisible }"
  >
    <app-filter-control
      title="Saved filters"
      [type]="filterType.Select"
      [options]="savedsearches"
      (editOption)="saveSearch($event)"
      [(ngModel)]="activeSavedSearchValue"
      [ngModelOptions]="{ standalone: true }"
      (filterChange)="applySavedFilter($event)"
      class="search-form__filters-panel__item"
      [badge]="activeSavedSearchValue ? 1 : null"
    >
      <button
        postfix
        mat-button
        color="primary"
        (click)="saveSearch()"
        class="save-filter-button small"
      >
        <mat-icon svgIcon="plus" class="save-filter-button__icon"></mat-icon>
        Save new filter
      </button>
    </app-filter-control>

    <app-filter-control
      [options]="statuses"
      formControlName="status"
      [fields]="['value', 'name']"
      [type]="filterType.Multiselect"
      class="search-form__filters-panel__item"
      [title]="'global_filter.status' | translate"
      [badge]="form.controls['status'].value?.length || null"
    >
    </app-filter-control>

    <app-filter-control
      formControlName="tags"
      [options]="categoriesData"
      [type]="filterType.Multilevelselect"
      [title]="'app.categories' | translate"
      class="search-form__filters-panel__item"
      [badge]="form.controls['tags'].value?.length || null"
    >
    </app-filter-control>

    <app-filter-control
      formControlName="date"
      [type]="filterType.Daterange"
      class="search-form__filters-panel__item"
      [title]="'global_filter.date_range' | translate"
      [badge]="
        form.controls['date'].value?.start?.length || form.controls['date'].value?.start?.length
          ? 1
          : null
      "
    >
    </app-filter-control>

    <app-filter-control
      [type]="filterType.Location"
      formControlName="center_point"
      class="search-form__filters-panel__item"
      [title]="'global_filter.location' | translate"
      [badge]="form.controls['center_point'].value?.length ? 1 : null"
    >
    </app-filter-control>

    <div class="search-form__filters-panel__group search-form__filters-panel__group--controls">
      <button
        color="dark"
        type="button"
        mat-stroked-button
        [disabled]="form.disabled"
        class="search-form__button"
        (click)="resetSavedFilter()"
      >
        Clear All
      </button>
    </div>
  </div>
</form>
